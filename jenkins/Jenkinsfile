pipeline {
    agent any

    parameters {
        string(name:'DB_HOST', defaultValue: 'dbMysql', description: 'db host')
        string(name:'Db_PASSWORD', defaultValue: 'db1234!', description: 'db password')
        string(name:'DB_NAME', defaultValue: 'dbName', description: 'db name')
        string(name:'DB_USER', defaultValue: 'user1234!', description: 'db user')
        string(name:'db_port', defaultValue: '3360', description: 'db port')
        string(name:'SECRET_KEY', defaultValue: 'secret_key', description: 'drf secret key')
        string(name:'GOOGLE_OAUTH2_CLIENT_ID', defaultValue: 'client id', description: 'google social login client id')
        string(name:'GOOGLE_OAUTH2_CLIENT_SECRET', defaultValue: 'client secret', description: 'google social login client secret')
    }
    stages {
        stage('Start Deploy') {
            agent any
            when {
                branch 'master'
            }
            steps {
                slackSend (channel: 'deploych', color: '#FFFF00', message: "STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
            }
        }

        stage('Check parameter prod') {
            when {
                branch 'master'
            }
            steps {
                script {
                    withAWS(region: 'ap-northeast-2', credentials: 'JenkinsUser'){
                        def db_name = sh(script: "aws ssm get-parameters --name DB_NAME | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def db_user = sh(script: "aws ssm get-parameters --name DB_USER | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def db_password = sh(script: "aws ssm get-parameters --name DB_PASSWORD | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def db_host = sh(script: "aws ssm get-parameters --name DB_HOST | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def db_port = sh(script: "aws ssm get-parameters --name DB_PORT | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def secret_key = sh(script: "aws ssm get-parameters --name SECRET_KEY | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def state = sh(script: "aws ssm get-parameters --name STATE | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def django_settings_module = sh(script: "aws ssm get-parameters --name /prod/DJANGO_SETTINGS_MODULE | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def google_oauth2_client_id = sh(script: "aws ssm get-parameters --name GOOGLE_OAUTH2_CLIENT_ID | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def google_oauth2_client_secret = sh(script: "aws ssm get-parameters --name GOOGLE_OAUTH2_CLIENT_SECRET | jq '.Parameters[0].Value'", returnStdout: true).trim()
                    }
                }
            }
        }

        stage('Start Test'){
            agent any
            when {
                branch 'test'
            }
            steps {
                slackSend (channel: 'test', color: '#FFFF00', message: "STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
            }
        }

        stage('Check parameter test'){
            when {
                branch 'test'
            }
            steps {
                script {
                    withAWS(region: 'ap-northeast-2', credentials: 'JenkinsUser'){
                        def secret_key = sh(script: "aws ssm get-parameters --name SECRET_KEY | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def state = sh(script: "aws ssm get-parameters --name STATE | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def django_settings_module = sh(script: "aws ssm get-parameters --name /test/DJANGO_SETTINGS_MODULE | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def google_oauth2_client_id = sh(script: "aws ssm get-parameters --name GOOGLE_OAUTH2_CLIENT_ID | jq '.Parameters[0].Value'", returnStdout: true).trim()
                        def google_oauth2_client_secret = sh(script: "aws ssm get-parameters --name GOOGLE_OAUTH2_CLIENT_SECRET | jq '.Parameters[0].Value'", returnStdout: true).trim()
                    }
                }
            }
        }
    }

    post {
        when {
            branch 'master'
        }
        success {
            slackSend (channel: 'deploych', color: '#00FF00', message: "SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
        }
        failure {
            slackSend (channel: 'deploych', color: '#FF0000', message: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
        }
    }
    post {
        when {
            branch 'test'
        }
        success {
            slackSend (channel: 'test', color: '#00FF00', message: "SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
        }
        failure {
            slackSend (channel: 'test', color: '#FF0000', message: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
        }
    }
}